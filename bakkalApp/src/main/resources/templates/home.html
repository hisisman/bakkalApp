<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakkal App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 70px; }
        /* Navbar */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 1030; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .navbar .ml-auto { display: flex; align-items: center; }
        .cart-badge { position: absolute; top: -5px; right: -10px; font-size: 12px; }
        /* Slider */
        .slider-container { position: relative; width: 100%; max-width: 1200px; height: 350px; margin: 20px auto; overflow: hidden; border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
        .slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .slider-button { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); border: none; color: white; font-size: 28px; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 2; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .slider-button:hover { background: rgba(0,0,0,0.7); transform: translateY(-50%) scale(1.2); box-shadow: 0 6px 15px rgba(0,0,0,0.5); }
        #prev-slide { left: 15px; }
        #next-slide { right: 15px; }
        /* ÃœrÃ¼nler */
        .products { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 40px; }
        .product { width: 220px; margin: 15px; padding: 15px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; position: relative; }
        .product:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .product h5 { font-weight: bold; margin-bottom: 10px; }
        .product p { font-size: 14px; color: #666; }
        .product .price { font-size: 18px; font-weight: bold; color: #28a745; margin-top: 10px; }
        .product form { margin-top: 10px; }
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { background: #28a745; color: #fff; padding: 10px 15px; border-radius: 5px; margin-top: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s ease; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/">Bakkal App</a>
    <div class="ml-auto d-flex align-items-center">
        <button class="btn btn-outline-primary position-relative mr-2" data-toggle="modal" data-target="#cartModal">
            ðŸ›’ Sepetim
            <span id="cart-count" class="badge badge-danger cart-badge">0</span>
        </button>
        <div class="user-buttons">
            <a th:href="@{/register}" class="btn btn-primary" th:if="${username} == null">Ãœye Ol</a>
            <a th:href="@{/login}" class="btn btn-secondary" th:if="${username} == null">GiriÅŸ Yap</a>
            <form action="/logout" method="POST" th:if="${username} != null" class="d-inline">
                <button type="submit" class="btn btn-danger">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-3">
    <div class="slider-container mt-4">
        <div class="slider" id="slider">
            <div class="slide" style="background-image: url('/images/kampanya-1.png');"></div>
            <div class="slide" style="background-image: url('/images/kampanya-2.png');"></div>
            <div class="slide" style="background-image: url('/images/kampanya-3.png');"></div>
        </div>
        <button class="slider-button" id="prev-slide">&#10094;</button>
        <button class="slider-button" id="next-slide">&#10095;</button>
    </div>

    <h3 class="text-center mt-5">ÃœrÃ¼nler</h3>
    <div class="products">
        <div th:each="product : ${products}" class="product"
             th:data-id="${product.id}"
             th:data-name="${product.name}"
             th:data-price="${product.price}">
            <img th:src="${product.imageUrl}" alt="ÃœrÃ¼n Resmi" style="width:100%; height:150px; object-fit:cover; border-radius:8px;"/>
            <h5 th:text="${product.name}">ÃœrÃ¼n AdÄ±</h5>
            <p th:text="${product.description}">ÃœrÃ¼n aÃ§Ä±klamasÄ±</p>
            <div class="price" th:text="${product.price + ' â‚º'}">0 â‚º</div>
            <form class="add-to-cart-form">
                <input type="hidden" name="productId" th:value="${product.id}"/>
                <input type="hidden" name="name" th:value="${product.name}"/>
                <input type="hidden" name="price" th:value="${product.price}"/>
                <input type="hidden" name="quantity" value="1"/>
                <button type="submit" class="btn btn-sm btn-success mt-2 add-to-cart-btn">Sepete Ekle</button>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cartModalLabel">Sepetiniz</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="cart-items"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">AlÄ±ÅŸveriÅŸe Devam Et</button>
                <button type="button" class="btn btn-success" id="checkout-btn" onclick="goToCheckout()">Ã–deme</button>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function updateCartCount() {
        document.getElementById('cart-count').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerText = message;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => { toast.style.opacity = '1'; }, 10);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2500);
    }

    // Home sayfasÄ± artÄ±/eksi
    function updateProductQuantityDisplay() {
        document.querySelectorAll('.product').forEach(productDiv => {
            const productId = productDiv.dataset.id.toString();
            const cartItem = cart.find(p => p.id === productId);

            let oldQuantityDiv = productDiv.querySelector('.cart-quantity');
            if (oldQuantityDiv) oldQuantityDiv.remove();

            if (cartItem) {
                const quantityDiv = document.createElement('div');
                quantityDiv.className = 'cart-quantity mt-2 d-flex align-items-center';
                const decreaseBtn = document.createElement('button');
                decreaseBtn.className = 'btn btn-sm btn-secondary mr-1 decrease-btn';
                decreaseBtn.innerText = '-';
                const quantitySpan = document.createElement('span');
                quantitySpan.className = 'mx-2 quantity';
                quantitySpan.textContent = cartItem.quantity;
                const increaseBtn = document.createElement('button');
                increaseBtn.className = 'btn btn-sm btn-secondary ml-1 increase-btn';
                increaseBtn.innerText = '+';

                quantityDiv.appendChild(decreaseBtn);
                quantityDiv.appendChild(quantitySpan);
                quantityDiv.appendChild(increaseBtn);
                productDiv.appendChild(quantityDiv);

                increaseBtn.onclick = () => {
                    cartItem.quantity++;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                    updateProductQuantityDisplay();
                };
                decreaseBtn.onclick = () => {
                    cartItem.quantity--;
                    if (cartItem.quantity <= 0) {
                        cart = cart.filter(p => p.id !== productId);
                    }
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                    updateProductQuantityDisplay();
                };
            }
        });
    }

    updateCartCount();
    updateProductQuantityDisplay();

    // Sepete ekle
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const productDiv = this.closest('.product');
            const productId = productDiv.dataset.id.toString();
            const existing = cart.find(p => p.id === productId);
            if (existing) existing.quantity++;
            else cart.push({
                id: productDiv.dataset.id,
                name: productDiv.dataset.name,
                price: parseFloat(productDiv.dataset.price),
                quantity: 1
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            updateProductQuantityDisplay();
            showToast(`${productDiv.dataset.name} sepete eklendi!`);
        });
    });

    // Modal render
    function renderCartModal() {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';
        if (cart.length === 0) { container.innerHTML = '<p>Sepetiniz boÅŸ.</p>'; return; }
        cart.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
            itemDiv.dataset.id = item.id;
            itemDiv.innerHTML = `
            <div>
                <strong>${item.name}</strong>
                <div class="d-flex align-items-center mt-1">
                    <button class="btn btn-sm btn-secondary decrease-btn mr-1">-</button>
                    <span class="mx-2 quantity">${item.quantity}</span>
                    <button class="btn btn-sm btn-secondary increase-btn ml-1">+</button>
                </div>
            </div>
            <div class="price">${(item.price * item.quantity).toFixed(2)} â‚º</div>
        `;
            container.appendChild(itemDiv);
        });

        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const totalDiv = document.createElement('div');
        totalDiv.className = 'mt-3 text-right font-weight-bold';
        totalDiv.textContent = `Toplam: ${total.toFixed(2)} â‚º`;
        container.appendChild(totalDiv);

        container.querySelectorAll('.increase-btn').forEach(btn => {
            btn.onclick = () => {
                const id = btn.closest('[data-id]').dataset.id;
                const cartItem = cart.find(p => p.id === id);
                cartItem.quantity++;
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
                updateProductQuantityDisplay();
                renderCartModal();
            };
        });
        container.querySelectorAll('.decrease-btn').forEach(btn => {
            btn.onclick = () => {
                const id = btn.closest('[data-id]').dataset.id;
                const cartItem = cart.find(p => p.id === id);
                cartItem.quantity--;
                if (cartItem.quantity <= 0) {
                    cart = cart.filter(p => p.id !== id);
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
                updateProductQuantityDisplay();
                renderCartModal();
            };
        });
    }

    function goToCheckout() {
        showToast('Ã–deme sayfasÄ±na yÃ¶nlendiriliyorsunuz!');
        // .html uzantÄ±sÄ±nÄ± kaldÄ±rÄ±n, Spring endpoint'ine yÃ¶nlendirin
        window.location.href = '/checkout';
    }

    $('#cartModal').on('show.bs.modal', renderCartModal);


</script>

</body>
</html>
